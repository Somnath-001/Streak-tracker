{% extends 'core/base.html' %}
{% load django_bootstrap5 %}
{% block content %}
    <h2>Performance Reports</h2>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Summary</h5>
            <p class="card-text">{{ summary }}</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Motivational Milestones</h5>
            {% if habit_data %}
                <div class="d-flex flex-wrap gap-3">
                    {% for milestone in milestones %}
                        <div class="text-center">
                            <span class="badge {{ milestone.color }} d-block mb-2 p-2" style="min-width: 150px;">{{ milestone.title }}</span>
                            <p class="small text-muted">{{ milestone.message }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No milestones yetâ€”start completing habits to unlock achievements!</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Ongoing Habit Completion Rates</h5>
            {% if habit_data %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Habit Name</th>
                            <th>Completion Rate</th>
                            <th>Highest Streak</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for habit in habit_data %}
                            <tr>
                                <td>{{ habit.name }}</td>
                                <td>{{ habit.completion_rate }}%</td>
                                <td>{{ habit.highest_streak }} day{{ habit.highest_streak|pluralize }}</td>
                                <td>{{ habit.is_completed|yesno:"Completed,Ongoing" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">No ongoing habits to report yet.</p>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Habit Completion Overview (Bar Graph)</h5>
            {% if habit_data %}
                <div style="height: 300px;">
                    <canvas id="habitBarChart"></canvas>
                </div>
            {% else %}
                <p class="text-muted">Add habits to see your performance bar graph.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Overall Completion Breakdown (Pie Chart)</h5>
            {% if habit_data %}
                <div style="height: 300px;">
                    <canvas id="habitPieChart"></canvas>
                </div>
            {% else %}
                <p class="text-muted">Add habits to see your completion breakdown.</p>
            {% endif %}
        </div>
    </div>

    {% if habit_data %}
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const barCtx = document.getElementById('habitBarChart').getContext('2d');
                const colors = ['#36A2EB', '#FF6384', '#4BC0C0', '#FFCE56', '#9966FF', '#FF9F40'];
                const habitNames = [{% for habit in habit_data %}'{{ habit.name }}',{% endfor %}];
                const habitRates = [{% for habit in habit_data %}{{ habit.completion_rate }},{% endfor %}];
                const habitBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: habitNames,
                        datasets: [{
                            label: 'Completion Rate (%)',
                            data: habitRates,
                            backgroundColor: colors.slice(0, habitNames.length),
                            borderColor: colors.slice(0, habitNames.length).map(c => c.replace('0.6', '1')),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: '#e9ecef' },
                                title: { display: true, text: 'Completion Rate (%)', font: { size: 14 } }
                            },
                            x: {
                                grid: { display: false },
                                title: { display: true, text: 'Habits', font: { size: 14 } }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top', labels: { font: { size: 12 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw}%`;
                                    }
                                }
                            }
                        }
                    }
                });

                const pieCtx = document.getElementById('habitPieChart').getContext('2d');
                const totalCompleted = {{ total_completed_days|default:0 }};
                const totalPossible = {{ total_possible_days|default:0 }};
                const habitPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Completed Days', 'Uncompleted Days'],
                        datasets: [{
                            data: [totalCompleted, totalPossible - totalCompleted],
                            backgroundColor: ['#28A745', '#DC3545'],
                            borderColor: ['#218838', '#C82333'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: true, position: 'top', labels: { font: { size: 12 } } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = totalCompleted + (totalPossible - totalCompleted);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} days (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        </script>
    {% endif %}

    <style>
        .bg-purple { background-color: #6f42c1 !important; color: white; }
        .bg-teal { background-color: #20c997 !important; color: white; }
        .bg-orange { background-color: #fd7e14 !important; color: white; }
    </style>
{% endblock %}